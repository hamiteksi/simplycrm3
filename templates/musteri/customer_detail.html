{% extends 'base.html' %}
{% load static %}

{% block title %}{{ main_customer.first_name }} {{ main_customer.last_name }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'musteri:customer_list' %}" class="text-decoration-none">Müşteriler</a></li>
<li class="breadcrumb-item active">{{ main_customer.first_name }} {{ main_customer.last_name }}</li>
{% endblock %}

{% block content %}
<!-- Müşteri Başlığı -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="fas fa-user-circle text-primary me-2"></i>
        {{ main_customer.first_name }} {{ main_customer.last_name }}
    </h1>
    <span class="badge bg-{{ main_customer.get_status_color }} fs-6">
        {{ main_customer.get_status_display }}
    </span>
</div>

<!-- Hızlı Menü -->
<div class="quick-menu mb-4">
    <div class="row g-2">
        <div class="col-md-3 col-6">
            <a href="#genel-bilgiler" class="quick-menu-link">
                <i class="fas fa-user"></i>
                Genel Bilgiler
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#pasaport-bilgileri" class="quick-menu-link">
                <i class="fas fa-passport"></i>
                Pasaport Bilgileri
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#basvuru-bilgileri" class="quick-menu-link">
                <i class="fas fa-file-alt"></i>
                Başvuru Bilgileri
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#ikamet-bilgileri" class="quick-menu-link">
                <i class="fas fa-home"></i>
                İkamet Bilgileri
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#dokumanlar" class="quick-menu-link">
                <i class="fas fa-file-alt"></i>
                Dokümanlar
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#notlar" class="quick-menu-link">
                <i class="fas fa-sticky-note"></i>
                Notlar
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#iletisim-gecmisi" class="quick-menu-link">
                <i class="fas fa-history"></i>
                İletişim Geçmişi
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#basvuru-surecleri" class="quick-menu-link">
                <i class="fas fa-tasks"></i>
                Başvuru Süreçleri
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="#odemeler" class="quick-menu-link">
                <i class="fas fa-money-bill"></i>
                Ödemeler
            </a>
        </div>
        <div class="col-md-3 col-6">
            <a href="{% url 'musteri:customer_edit' main_customer.id %}" class="quick-menu-link">
                <i class="fas fa-edit"></i>
                Düzenle
            </a>
        </div>
    </div>
</div>

<!-- Ana İçerik -->
<div class="row">
    <!-- Sol Kolon - Müşteri Bilgileri -->
    <div class="col-lg-8">
        <!-- Genel Bilgiler -->
        <div class="card mb-4" id="genel-bilgiler">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-info-circle text-primary me-2"></i>
                    Genel Bilgiler
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-group">
                            <label>Ad Soyad</label>
                            <p>{{ main_customer.first_name }} {{ main_customer.last_name }}</p>
                        </div>
                        <div class="info-group">
                            <label>TC Kimlik No</label>
                            <p>{{ main_customer.identity_number|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Uyruk</label>
                            <p>{{ main_customer.nationality|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Doğum Tarihi</label>
                            <p>{{ main_customer.date_of_birth|date:"d.m.Y"|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Medeni Durum</label>
                            <p>{{ main_customer.marital_status|default:"-" }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-group">
                            <label>Telefon</label>
                            <p>{{ main_customer.phone|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Email</label>
                            <p>{{ main_customer.email|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Durum</label>
                            <p>
                                <span class="badge bg-{{ main_customer.get_status_color }}">
                                    {{ main_customer.get_status_display }}
                                </span>
                            </p>
                        </div>
                        <div class="info-group">
                            <label>Kayıt Tarihi</label>
                            <p>{{ main_customer.created_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pasaport Bilgileri -->
        <div class="card mb-4" id="pasaport-bilgileri">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-passport text-primary me-2"></i>
                    Pasaport Bilgileri
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-group">
                            <label>Pasaport No</label>
                            <p>{{ main_customer.passport_number|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Düzenleyen Makam</label>
                            <p>{{ main_customer.issuing_authority|default:"-" }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-group">
                            <label>Pasaport Tarihi</label>
                            <p>{{ main_customer.passport_date|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Pasaport Notları</label>
                            <p>{{ main_customer.passport_info|default:"-" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Başvuru Bilgileri -->
        <div class="card mb-4" id="basvuru-bilgileri">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-file-alt text-primary me-2"></i>
                    Başvuru Bilgileri
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-group">
                            <label>Başvuru Tipi</label>
                            <p>{{ main_customer.application_type|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>İkamet Tipi</label>
                            <p>{{ main_customer.residence_type|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Hizmet Tipi</label>
                            <p>{{ main_customer.service_type|default:"-" }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-group">
                            <label>İkamet İzni Başlangıç</label>
                            <p>{{ main_customer.residence_permit_start_date|date:"d.m.Y"|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>İkamet İzni Bitiş</label>
                            <p>{{ main_customer.residence_permit_end_date|date:"d.m.Y"|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>PTT Takip Kodu</label>
                            <p>{{ main_customer.ptt_code|default:"-" }}</p>
                        </div>
                        <div class="info-group">
                            <label>Başvuru Numarası</label>
                            <p>{{ main_customer.application_number|default:"-" }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- İkamet Bilgileri -->
        <div class="card mb-4" id="ikamet-bilgileri">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-home text-primary me-2"></i>
                    İkamet Bilgileri
                </h5>
                <div class="row">
                    <div class="col-12">
                        <div class="info-group">
                            <label>Adres</label>
                            <p>{{ main_customer.address|default:"-"|linebreaks }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dokümanlar -->
        <div class="card mb-4" id="dokumanlar">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt text-primary me-2"></i>
                    Dokümanlar
                </h5>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                    <i class="fas fa-plus me-1"></i> Doküman Ekle
                </button>
            </div>
            <div class="card-body">
                {% if dokumanlar %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Doküman Tipi</th>
                                    <th>Yüklenme Tarihi</th>
                                    <th>Notlar</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for dokuman in dokumanlar %}
                                <tr>
                                    <td>{{ dokuman.dokuman_tipi }}</td>
                                    <td>{{ dokuman.yuklenme_tarihi|date:"d.m.Y H:i" }}</td>
                                    <td>{{ dokuman.notlar|default:"-" }}</td>
                                    <td>
                                        <a href="{{ dokuman.dosya.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fas fa-download"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">Henüz doküman yüklenmemiş.</p>
                {% endif %}
            </div>
        </div>

        <!-- Doküman Ekleme Modal -->
        <div class="modal fade" id="addDocumentModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Doküman Ekle</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form action="{% url 'dokuman:dokuman_yukle' main_customer.id %}" method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Doküman Tipi</label>
                                <select name="dokuman_tipi" class="form-select" required>
                                    <option value="">Seçiniz...</option>
                                    {% for tip in dokuman_tipleri %}
                                    <option value="{{ tip.id }}">{{ tip.get_ad_display }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Dosya</label>
                                <input type="file" name="dosya" class="form-control" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Notlar</label>
                                <textarea name="notlar" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                            <button type="submit" class="btn btn-primary">Yükle</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Başvuru Süreçleri -->
        <div class="card mb-4" id="basvuru-surecleri">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="fas fa-tasks text-primary me-2"></i>
                    Başvuru Süreçleri
                </h5>
                <a href="{% url 'dokuman:basvuru_sureci_olustur' main_customer.id %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-plus me-1"></i>
                    Yeni Başvuru
                </a>
            </div>
            <div class="card-body">
                {% if basvuru_surecleri %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Başvuru Türü</th>
                                <th>Durum</th>
                                <th>Başlangıç</th>
                                <th>Bitiş</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for basvuru in basvuru_surecleri %}
                            <tr>
                                <td>{{ basvuru.get_basvuru_tipi_display }}</td>
                                <td>
                                    <span class="badge bg-{{ basvuru.get_durum_color }}">
                                        {{ basvuru.get_durum_display }}
                                    </span>
                                </td>
                                <td>{{ basvuru.baslangic_tarihi|date:"d.m.Y" }}</td>
                                <td>{{ basvuru.bitis_tarihi|date:"d.m.Y" }}</td>
                                <td>
                                    <a href="{% url 'dokuman:basvuru_sureci_guncelle' basvuru.id %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted text-center my-4">Henüz başvuru süreci başlatılmamış.</p>
                {% endif %}
            </div>
        </div>

        <!-- Ödemeler -->
        <div class="card mb-4" id="odemeler">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="fas fa-money-bill text-primary me-2"></i>
                    Ödemeler
                </h5>
                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPaymentModal">
                    <i class="fas fa-plus me-1"></i> Ödeme Ekle
                </button>
            </div>
            <div class="card-body">
                {% if main_customer.payments.all %}
                    <div class="table-responsive mb-3">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Tutar</th>
                                    <th>Açıklama</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in main_customer.payments.all %}
                                <tr>
                                    <td>{{ payment.date|date:"d.m.Y H:i" }}</td>
                                    <td>{{ payment.amount }}₺</td>
                                    <td>{{ payment.description|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-3">Henüz ödeme kaydı bulunmuyor.</p>
                {% endif %}
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Toplam Ödeme</h6>
                        <h3 class="mb-0 text-primary">{{ main_customer.payment_made|default:"0" }}₺</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sağ Kolon - Notlar ve İletişim -->
    <div class="col-lg-4">
        <!-- Etkinlikler -->
        <div class="card mb-4" id="etkinlikler">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="fas fa-calendar text-primary me-2"></i>
                    Etkinlikler
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">
                    <i class="fas fa-plus me-1"></i>
                    Etkinlik Ekle
                </button>
            </div>
            <div class="card-body">
                {% if calendar_events %}
                <div class="events-list">
                    {% for event in calendar_events %}
                    <div class="event-item mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">{{ event.title }}</h6>
                            <div>
                                <button class="btn btn-sm btn-warning me-1" onclick="editEvent({{ event.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteEvent({{ event.id }})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="text-muted small mb-2">
                            <i class="fas fa-clock me-1"></i>
                            {{ event.start_time|date:"d.m.Y H:i" }}
                            {% if event.end_time %}
                            - {{ event.end_time|date:"d.m.Y H:i" }}
                            {% endif %}
                        </div>
                        {% if event.description %}
                        <p class="mb-0 small">{{ event.description }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center my-4">Henüz etkinlik eklenmemiş.</p>
                {% endif %}
            </div>
        </div>

        <!-- Notlar -->
        <div class="card mb-4" id="notlar">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0">
                    <i class="fas fa-sticky-note text-primary me-2"></i>
                    Notlar
                </h5>
                <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                    <i class="fas fa-plus me-1"></i>
                    Not Ekle
                </button>
            </div>
            <div class="card-body">
                {% if notes %}
                <div class="notes-list">
                    {% for note in notes %}
                    <div class="note-item mb-3 p-3 bg-light rounded">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ note.created_at|date:"d.m.Y H:i" }}</small>
                            <button class="btn btn-sm btn-link text-danger p-0" onclick="deleteNote({{ note.id }})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="mb-0">{{ note.content }}</p>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center my-4">Henüz not eklenmemiş.</p>
                {% endif %}
            </div>
        </div>

        <!-- İletişim Geçmişi -->
        <div class="card mb-4" id="iletisim-gecmisi">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="fas fa-history text-primary me-2"></i>
                    İletişim Geçmişi
                </h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for contact in contact_history %}
                    <div class="timeline-item">
                        <div class="timeline-marker"></div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between mb-1">
                                <small class="text-muted">{{ contact.date|date:"d.m.Y H:i" }}</small>
                                <span class="badge bg-{{ contact.get_type_color }}">{{ contact.get_type_display }}</span>
                            </div>
                            <p class="mb-0">{{ contact.description }}</p>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted text-center my-4">Henüz iletişim kaydı bulunmuyor.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Not Ekleme Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Not Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'musteri:add_note' main_customer.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Not</label>
                        <textarea name="content" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Ekle</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ödeme Ekleme Modal -->
<div class="modal fade" id="addPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Ödeme</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'musteri:add_payment' main_customer.id %}" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tutar</label>
                        <div class="input-group">
                            <input type="number" name="amount" class="form-control" required>
                            <span class="input-group-text">₺</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Açıklama</label>
                        <textarea name="description" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Etkinlik Düzenleme Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Etkinlik Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editEventForm">
                {% csrf_token %}
                <input type="hidden" name="event_id" id="edit_event_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Etkinlik Başlığı</label>
                        <input type="text" class="form-control" name="title" id="edit_event_title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Başlangıç Tarihi</label>
                        <input type="datetime-local" class="form-control" name="start" id="edit_event_start" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bitiş Tarihi</label>
                        <input type="datetime-local" class="form-control" name="end" id="edit_event_end">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Açıklama</label>
                        <textarea class="form-control" name="description" id="edit_event_description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Etkinlik Ekleme Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Etkinlik Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addEventForm">
                {% csrf_token %}
                <input type="hidden" name="customer_id" value="{{ main_customer.id }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Etkinlik Başlığı</label>
                        <input type="text" class="form-control" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Başlangıç Tarihi</label>
                        <input type="datetime-local" class="form-control" name="start" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bitiş Tarihi</label>
                        <input type="datetime-local" class="form-control" name="end">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Açıklama</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Not silme fonksiyonu
function deleteNote(noteId) {
    if (confirm('Bu notu silmek istediğinizden emin misiniz?')) {
        fetch(`/musteri/note/${noteId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

// Doküman silme fonksiyonu
function deleteDocument(documentId) {
    if (confirm('Bu dokümanı silmek istediğinizden emin misiniz?')) {
        fetch(`/dokuman/${documentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

// Smooth scroll
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelector(this.getAttribute('href')).scrollIntoView({
            behavior: 'smooth'
        });
    });
});

// Etkinlik silme fonksiyonu
function deleteEvent(eventId) {
    if (confirm('Bu etkinliği silmek istediğinizden emin misiniz?')) {
        fetch(`{% url "musteri:calendar_event_delete" event_id=0 %}`.replace('0', eventId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Etkinlik silinirken bir hata oluştu');
            }
        });
    }
}

// Etkinlik düzenleme fonksiyonu
function editEvent(eventId) {
    fetch(`{% url "musteri:calendar_event_detail" event_id=0 %}`.replace('0', eventId), {
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('edit_event_id').value = data.id;
        document.getElementById('edit_event_title').value = data.title;
        document.getElementById('edit_event_start').value = data.start.slice(0, 16);
        if (data.end) {
            document.getElementById('edit_event_end').value = data.end.slice(0, 16);
        }
        document.getElementById('edit_event_description').value = data.description || '';
        
        new bootstrap.Modal(document.getElementById('editEventModal')).show();
    });
}

// Etkinlik düzenleme formunu gönderme
document.getElementById('editEventForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const eventId = formData.get('event_id');
    
    fetch(`{% url "musteri:calendar_event_update" event_id=0 %}`.replace('0', eventId), {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Etkinlik güncellenirken bir hata oluştu');
    });
});

// Etkinlik ekleme formunu gönderme
document.getElementById('addEventForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "musteri:calendar_event_create" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
        } else {
            location.reload();
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Etkinlik eklenirken bir hata oluştu');
    });
});
</script>
{% endblock %}